---
title: 'Project 2: Modeling of Wechat Red Envelope'
author: "Jun Mei (90884092)"
date: "November 6, 2017"
output:
  pdf_document: default
  html_document: default
---

## Dataset

We made 14 Wechat Red Envelopes. Each of them is divided into 20 parts with a total of 200 cents. Therefore we have $14 \times 20 = 280$ numbers. We can get the mean by arithmetic, which is $200 / 20 = 10$ cents. The raw data is as following:

```{r}
rawData <- read.csv("data.csv", header = FALSE)
rawData
```

In which, each column is an envelope, and each cell is an amount. List all the amounts and summary them:

```{r}
dataV <- unlist(rawData)
summary(dataV)
```

We build a data frame in order to draw some figures.

```{r}
df <- data.frame(amount=dataV, envelope=rep(1:14, each=20), hand=rep(20:1, 14))
summary(df)
```

Now, we can use `ggplot2` library to plot and observe the data.

```{r}
library(ggplot2)
ggplot(df) + geom_point(aes(x=hand, y=amount, color=envelope, shape=envelope)) +
  scale_color_identity() + scale_shape_identity()
```

We can find that the first ten hands are more concent, and the last ten hands are more decentralized. Therefore, we should summary them separately.

```{r}
df1 <- df[df$hand <= 10,]
df2 <- df[df$hand >= 11,]
summary(df1$amount)
summary(df2$amount)
```

The mean of the last ten hands are higher. The standard deviation of the first ten hands is `r sd(df1$amount)`, and one of the last ten hands is `r sd(df2$amount)`. Therefore, the latter hands have higher mean and higher standard deviation.

For all the amounts of all envelopes, we plot the bar figure:

```{r}
ggplot(df, aes(amount)) + geom_bar()
```

The amount bar figure shows that most amounts are in $[0.01, 0.19]$.

## Assumptions

We assume all the Wechat Red Envelopes are independent and identically distributed. We guess that all the amounts of one envelope are sampled from a uniform distribution, and then normalized to match the total amount. We believe the programmers in Wechat will not sample from a complex distribution. The simplest distribution in the most popular programming languages is the uniform distribution $\mathrm{Unif}(0, 1)$. Note that since the minimum unit of amount is one cent, so we should round off the amounts. We round down all the amounts except the last amount, and the last amount is the remaining amount from the total.

## Model

We suppose the amounts $x$ is generated by a model $\theta$. Therefore we have
$$\begin{aligned}
  P(\theta | x) &= \frac{P(x | \theta) P(\theta)}{P(x)}\\
  &\propto P(x | \theta) P(\theta).
\end{aligned}$$
The $P(\theta | x)$ is called posterior probability, $P(x | \theta)$ is called likelihood, and $P(\theta)$ is called prior probability. The prior probability is hard to approximate, so we employ maximum likelihood estimation:

$$\begin{aligned}
  \arg\max_\theta P(x | \theta).
\end{aligned}$$

Because our assumption is complex such that we cannot find a clear distribution matching it, we sample a same dataset, and then plot the bar figure. We believe that our assumption is very likely to be correct if the two bar figures are similar.

## Simulations

We write code the simulate 14 envelopes and each of them has 20 hands with a total of 200 cents.

```{r}
set.seed(3)
one_envelope <- function() {
  n <- 20
  total <- 200
  hands <- runif(n)
  hands <- total * hands / sum(hands)
  hands <- floor(hands)
  hands <- pmax(hands, 1)
  hands[n] <- hands[n] + total - sum(hands)
  hands <- hands / 100
  hands
}
genData <- replicate(14, one_envelope())
gf <- data.frame(amount=c(genData), envelope=rep(1:14, each=20), hand=rep(1:20, 14))
ggplot(gf) + geom_point(aes(x=hand, y=amount, color=envelope, shape=envelope)) +
  scale_color_identity() + scale_shape_identity()
ggplot(gf, aes(amount)) + geom_bar()
```

We can see that the point figure matches the truth. The decentralization of the latter hands is caused by rounding-off operations. The former hands rounds down, and the very last hand get the remained amount. The bar figure also matches the truth. This is because all the hands have the same mean $0.1$. Therefore, the counts of amounts between $0.01$ and $0.19$ dominate.

### Second assumption

Beyond our initial assumption, we made another assumption, which is similar with the first one. The difference is we normalize each hand with all the remaining hands.

```{r}
set.seed(3)
one_envelope2 <- function() {
  n <- 20
  total <- 200
  hands <- runif(n)
  for (k in 1:n) {
    hands[k] <- min(total - (n-k), max(1, floor(total * hands[k] / sum(hands[k:n]))))
    total <- total - hands[k]
  }
  hands <- hands / 100
  hands
}

genData <- replicate(14, one_envelope2())
gf <- data.frame(amount=c(genData), envelope=rep(1:14, each=20), hand=rep(1:20, 14))
ggplot(gf) + geom_point(aes(x=hand, y=amount, color=envelope, shape=envelope)) +
  scale_color_identity() + scale_shape_identity()
ggplot(gf, aes(amount)) + geom_bar()
```

We can see that the bar figure count also matches. The point figure is a little worse than the first assumption.

### Third assumption

The last assumpiton we tried is for each hand, we sample from a uniform distribution where the maximum value is 2 times the remaining mean. This assumption is reasonable because it also keeps the mean with the truth.

```{r}
set.seed(3)
one_envelope3 <- function() {
  n <- 20
  total <- 200
  hands <- rep(0, 20)
  for (k in 1:n) {
    hands[k] <- min(total - (n-k), max(1, floor(runif(1, max=total/(n-k+1)*2))))
    total <- total - hands[k]
  }
  hands[n] <- hands[n] + total
  hands <- hands / 100
  hands
}
genData <- replicate(14, one_envelope3())
gf <- data.frame(amount=c(genData), envelope=rep(1:14, each=20), hand=rep(1:20, 14))
ggplot(gf) + geom_point(aes(x=hand, y=amount, color=envelope, shape=envelope)) +
  scale_color_identity() + scale_shape_identity()
ggplot(gf, aes(amount)) + geom_bar()
```

## $N$ persons with $N + 1$ cents

There is a corner case of $N$ persons with $N+1$ cents. We have test more than 10 times, the last person always get 2 cents, and the others always get 1 cent. We guess this is because of some rounding-off operations. All our assumpitons matches the truth of $N$ persons with $N+1$ cents.
